<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Details</title>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="lake-details-page">
    <h1>Lake Details</h1>
    <div id="lake-details" class="kpi-container"></div>
    <canvas id="parametersChart" width="400" height="200"></canvas>
    <button id="reload-button" style="display: none;" onclick="window.location.reload();">Reload Page</button>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lakeName = urlParams.get('name');
        const date = urlParams.get('date');

        if (!lakeName || !date) {
            document.getElementById('lake-details').textContent = 'Invalid lake or date. Please go back and try again.';
        } else {
            fetch(`/lake_data?name=${lakeName}&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    const lakeDetailsDiv = document.getElementById('lake-details');

                    if (data.error) {
                        lakeDetailsDiv.textContent = data.error;
                    } else if (data.message) {
                        lakeDetailsDiv.innerHTML = `
                        <h2>Model is generating data for ${lakeName} on ${date}</h2>
                        <p>The data was not available in the database. Please click the button below to reload the page and view the generated data.</p>
                        `;
                        document.getElementById('reload-button').style.display = 'block';
                    } else {
                        lakeDetailsDiv.innerHTML = `<h2>Details for ${lakeName} on ${date}</h2>`;
                        const lakeData = data.lake_data;

                        const samples = lakeData.map((sample, index) =>
                            `<option value="${index}">Sample ${index + 1} (${sample.model_generated ? 'Generated by Model' : 'Existing Data'})</option>`
                        ).join('');
                        lakeDetailsDiv.innerHTML += `
                            <label for="sample-select">Choose a sample:</label>
                            <select id="sample-select">${samples}</select>
                            <div id="sample-details" class="kpi-container"></div>
                        `;

                        document.getElementById('sample-select').addEventListener('change', function() {
                            const selectedSample = lakeData[this.value];
                            const sampleDetailsDiv = document.getElementById('sample-details');
                            sampleDetailsDiv.innerHTML = `
                                <div class="kpi"><span>SD:</span> ${selectedSample.sd ? selectedSample.sd.toFixed(2) : 'Not available'}</div>
                                <div class="kpi"><span>Chlorophyll:</span> ${selectedSample.chlorophyll ? selectedSample.chlorophyll.toFixed(2) : 'Not available'}</div>
                                <div class="kpi"><span>TP:</span> ${selectedSample.tp ? selectedSample.tp.toFixed(2) : 'Not available'}</div>
                                <div class="kpi"><span>TNO2:</span> ${selectedSample.tno2 ? selectedSample.tno2.toFixed(2) : 'Not available'}</div>
                            `;

                            // Prepare data for the chart
                            const chartData = {
                                labels: ['SD', 'Chlorophyll', 'TP', 'TNO2'],
                                datasets: [{
                                    label: 'Water Parameters',
                                    data: [
                                        selectedSample.sd ? selectedSample.sd.toFixed(2) : null,
                                        selectedSample.chlorophyll ? selectedSample.chlorophyll.toFixed(2) : null,
                                        selectedSample.tp ? selectedSample.tp.toFixed(2) : null,
                                        selectedSample.tno2 ? selectedSample.tno2.toFixed(2) : null
                                    ],
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            };

                            // Render the chart
                            const ctx = document.getElementById('parametersChart').getContext('2d');
                            if (window.myChart) {
                                window.myChart.destroy();
                            }
                            window.myChart = new Chart(ctx, {
                                type: 'line',
                                data: chartData,
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        });

                        document.getElementById('sample-select').dispatchEvent(new Event('change'));
                    }
                })
                .catch(error => console.error('Error fetching lake data:', error));
        }
    </script>
</body>
</html>
